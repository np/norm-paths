module paths where

open import Function.NP hiding (_âˆ‹_)
open import Type using (â˜…)
open import Data.Product renaming (_,_ to _,,_)
open import Data.Sum renaming ([_,_] to [[_,_]])
open import Data.Zero
open import Data.One

import Relation.Binary.PropositionalEquality as â‰¡
open â‰¡ using (_â‰¡_; _â‰¢_)

infix 0 _âˆ‹_ _âŠ¢_ _âŠ¢â¿_
infixl 6 _Â·_ _,_
infixr 6 _â‡’_

private -- for instance arguments
    0â‚,,0â‚ : ğŸ™ Ã— ğŸ™
    0â‚,,0â‚ = 0â‚ ,, 0â‚

data Ty : â˜… where
  a b c : Ty
  _â‡’_ : (A B : Ty) â†’ Ty

data Ctx : â˜… where
  Îµ : Ctx
  _,_ : (Î“ : Ctx) (A : Ty) â†’ Ctx

data _âˆ‹_ : Ctx â†’ Ty â†’ â˜… where
  top : âˆ€ {Î“} A â†’ (Î“ , A) âˆ‹ A
  pop : âˆ€ {Î“ A} B â†’ Î“ âˆ‹ A â†’ (Î“ , B) âˆ‹ A
  
data _â‰ _ : âˆ€ {Î“ A B} (x : Î“ âˆ‹ A) (y : Î“ âˆ‹ B) â†’ â˜… where
  topâ‰ pop : âˆ€ {Î“ A B} (x : Î“ âˆ‹ B) â†’ top A â‰  pop A x
  popâ‰ top : âˆ€ {Î“ A B} (x : Î“ âˆ‹ B) â†’ pop A x â‰  top A
  popâ‰ pop : âˆ€ {Î“ A B} {x y : Î“ âˆ‹ A} â†’ x â‰  y â†’ pop B x â‰  pop B y

pop-inj : âˆ€ {Î“ A B} {x y : Î“ âˆ‹ A} â†’ pop B x â‰¡ pop B y â†’ x â‰¡ y
pop-inj â‰¡.refl = â‰¡.refl

-- â‰  is sound
â‰ â†’â‰¢ : âˆ€ {Î“ A} {x y : Î“ âˆ‹ A} â†’ x â‰  y â†’ x â‰¢ y
â‰ â†’â‰¢ (topâ‰ pop p) ()
â‰ â†’â‰¢ (popâ‰ top p) ()
â‰ â†’â‰¢ (popâ‰ pop p) q = â‰ â†’â‰¢ p (pop-inj q)

data _âŠ¢_ : Ctx â†’ Ty â†’ â˜… where
  V   : âˆ€ {Î“ A}

        â†’ Î“ âˆ‹ A
        ---------
        â†’ Î“ âŠ¢ A

  _Â·_ : âˆ€ {Î“ A B}

        â†’ Î“ âŠ¢ A â‡’ B
        â†’ Î“ âŠ¢ A
        ------------
        â†’ Î“ âŠ¢ B

  Æ›   : âˆ€ {Î“ A B}

        â†’ Î“ , A âŠ¢ B
        -------------
        â†’ Î“ âŠ¢ A â‡’ B

infix 0 _â‡‰_
_â‡‰_ : (Î“ Î” : Ctx) â†’ â˜…
Î“ â‡‰ Î” = âˆ€ {B} â†’ Î“ âˆ‹ B â†’ Î” âˆ‹ B

extâ‡‰ : âˆ€ {Î“ Î” A} â†’ Î“ â‡‰ Î” â†’ Î“ , A â‡‰ Î” , A
extâ‡‰ f (top A)   = top A
extâ‡‰ f (pop B x) = pop B (f x)

data _âŠ¢â¿_   : Ctx â†’ Ty â†’ â˜…
data _âŠ¢Ë¢_â†_ : Ctx â†’ Ty â†’ Ty â†’ â˜…

data _âŠ¢Ë¢_â†_ where

  [] : âˆ€ {Î“ A}
      â†’ Î“ âŠ¢Ë¢ A â† A

  _âˆ·_ : âˆ€ {Î“ A B C}
        â†’ Î“ âŠ¢â¿ A
        â†’ Î“ âŠ¢Ë¢ B â† C
        -------------------
        â†’ Î“ âŠ¢Ë¢ (A â‡’ B) â† C

data _âŠ¢â¿_ where
  V   : âˆ€ {Î“ A B}

        â†’ Î“ âˆ‹ A
        â†’ Î“ âŠ¢Ë¢ A â† B
        ------------
        â†’ Î“ âŠ¢â¿ B

  Æ›   : âˆ€ {Î“ A B}

        â†’ Î“ , A âŠ¢â¿ B
        -------------
        â†’ Î“ âŠ¢â¿ A â‡’ B

module âŠ¢â¿â†’âŠ¢ where
  [_Â·_]Ë¢ : âˆ€ {Î“ A B} â†’ Î“ âŠ¢ A â†’ Î“ âŠ¢Ë¢ A â† B â†’ Î“ âŠ¢ B
  [_]â¿   : âˆ€ {Î“ A}   â†’ Î“ âŠ¢â¿ A â†’ Î“ âŠ¢ A

  [ h Â· []     ]Ë¢ = h
  [ h Â· t âˆ· ts ]Ë¢ = [ (h Â· [ t ]â¿) Â· ts ]Ë¢

  [ V x ts ]â¿ = [ V x Â· ts ]Ë¢
  [ Æ› t    ]â¿ = Æ› [ t ]â¿

_++Ë¢_ : âˆ€ {Î“ A B C} â†’ Î“ âŠ¢Ë¢ A â† B â†’ Î“ âŠ¢Ë¢ B â† C â†’ Î“ âŠ¢Ë¢ A â† C
[]       ++Ë¢ us = us
(t âˆ· ts) ++Ë¢ us = t âˆ· (ts ++Ë¢ us)

  --_ : âˆ€ {Î“ A B} â†’ Î“ âŠ¢â¿ A â‡’ B â†’ Î“ âŠ¢â¿ A â†’ Î“ âŠ¢â¿ B

module substâ¿ where
    _$â¿_ : âˆ€ {Î“ Î” A}   â†’ Î“ â‡‰ Î” â†’ Î“ âŠ¢â¿ A â†’ Î” âŠ¢â¿ A
    _$Ë¢_ : âˆ€ {Î“ Î” A B} â†’ Î“ â‡‰ Î” â†’ Î“ âŠ¢Ë¢ A â† B â†’ Î” âŠ¢Ë¢ A â† B

    f $â¿ (V x ts) = V (f x) (f $Ë¢ ts)
    f $â¿ (Æ› M)    = Æ› (extâ‡‰ f $â¿ M)

    f $Ë¢ []       = []
    f $Ë¢ (x âˆ· ts) = (f $â¿ x) âˆ· (f $Ë¢ ts)

    infix 0 _â‡¶â¿_
    _â‡¶â¿_ : (Î“ Î” : Ctx) â†’ â˜…
    Î“ â‡¶â¿ Î” = âˆ€ {B} â†’ Î“ âˆ‹ B â†’ Î” âŠ¢â¿ B

    extâ‡¶â¿ : âˆ€ {Î“ Î” A} â†’ Î“ â‡¶â¿ Î” â†’ Î“ , A â‡¶â¿ Î” , A
    extâ‡¶â¿ f (top A)   = V (top A) []
    extâ‡¶â¿ f (pop B x) = (Î» Î“ â†’ pop B Î“) $â¿ f x

    subst0 : âˆ€ {Î“ A} â†’ Î“ âŠ¢â¿ A â†’ Î“ , A â‡¶â¿ Î“
    subst0 M (top A)   = M
    subst0 M (pop B x) = V x []

    {-
    infix 8 _=<<â¿_ _=<<Ë¢_
    _=<<â¿_ : âˆ€ {Î“ Î” A} â†’ Î“ â‡¶â¿ Î” â†’ Î“ âŠ¢â¿ A â†’ Î” âŠ¢â¿ A
    _=<<Ë¢_ : âˆ€ {Î“ Î” A B} â†’ Î“ â‡¶â¿ Î” â†’ Î“ âŠ¢Ë¢ A â† B â†’ Î” âŠ¢Ë¢ A â† B

    _Â·â¿_ : âˆ€ {Î“ A B} â†’ Î“ âŠ¢â¿ A â†’ Î“ âŠ¢Ë¢ A â† B â†’ Î“ âŠ¢â¿ B
    V x ts Â·â¿ us       = V x (ts ++Ë¢ us)
    Æ› t    Â·â¿ []       = Æ› t
    Æ› t    Â·â¿ (u âˆ· us) = (subst0 u =<<â¿ t) Â·â¿ us

    f =<<Ë¢ []     = []
    f =<<Ë¢ t âˆ· ts = (f =<<â¿ t) âˆ· (f =<<Ë¢ ts)

    f =<<â¿ V x ts  = f x Â·â¿ (f =<<Ë¢ ts)
    f =<<â¿ Æ› M     = Æ› (extâ‡¶â¿ f =<<â¿ M)

    appâ¿ : âˆ€ {Î“ A B} â†’ Î“ âŠ¢â¿ A â‡’ B â†’ Î“ âŠ¢â¿ A â†’ Î“ âŠ¢â¿ B
    appâ¿ t u = t Â·â¿ (u âˆ· [])

    cut : âˆ€ {Î“ A B} â†’ Î“ , A âŠ¢â¿ B â†’ Î“ âŠ¢â¿ A â†’ Î“ âŠ¢â¿ B
    cut M N = subst0 N =<<â¿ M
    -}

    {-
module norm where
  open substâ¿

  nrm : âˆ€ {Î“ A} â†’ Î“ âŠ¢ A â†’ Î“ âŠ¢â¿ A
  nrm (V x)   = V x []
  nrm (t Â· u) = appâ¿ (nrm t) (nrm u)
  nrm (Æ› t)   = Æ› (nrm t)
  -}

-- _âŠ†_ : Ty â†’ Ty â†’ â˜…

data Ty[_] : Ty â†’ â˜… where
  âˆ™     : âˆ€ {A} â†’ Ty[ A ]
  [_]â‡’_ : âˆ€ {A} (pá´¬ : Ty[ A ]) (B : Ty) â†’ Ty[ A â‡’ B ]
  _â‡’[_] : âˆ€ {B} (A : Ty) (pá´® : Ty[ B ]) â†’ Ty[ A â‡’ B ]

data Ctx[_Â·_] : âˆ€ {Î“ A} â†’ Î“ âˆ‹ A â†’ (pá´¬ : Ty[ A ]) â†’ â˜… where
  [_],_ : âˆ€ {Î“ A} {AâˆˆÎ“ : Î“ âˆ‹ A} {pá´¬ : Ty[ A ]} (p : Ctx[ AâˆˆÎ“ Â· pá´¬ ]) (B : Ty) â†’ Ctx[ pop B AâˆˆÎ“ Â· pá´¬ ]
  _,[_] : âˆ€ (Î“ : Ctx) {A : Ty} (pá´¬ : Ty[ A ]) â†’ Ctx[ top {Î“} A Â· pá´¬ ]

infix 0 _[âŠ¢]_ _âŠ¢[_] [_]âŠ¢_
infix 3 [_]â‡’_ [_],_ _,[_]

data _[âŠ¢]_ : âˆ€ Î“ C â†’ â˜… where
  [_]âŠ¢_ : âˆ€ {Î“ A} {x : Î“ âˆ‹ A} {pá´¬ : Ty[ A ]} (p : Ctx[ x Â· pá´¬ ]) (C : Ty) â†’ Î“ [âŠ¢] C
  _âŠ¢[_] : âˆ€ Î“ {C} (pC : Ty[ C ]) â†’ Î“ [âŠ¢] C

infix 0 _[âŠ¢]2_
data _[âŠ¢]2_ (Î“ : Ctx) (A : Ty) : â˜… where
  [_]   : (p : Î“ [âŠ¢] A) â†’ Î“ [âŠ¢]2 A
  [_&_] : âˆ€ (p q : Î“ [âŠ¢] A) â†’ Î“ [âŠ¢]2 A

[_â…‹_] : âˆ€ {Î“ A} (p q : Î“ [âŠ¢] A) â†’ Î“ [âŠ¢]2 A
[ p â…‹ q ] = [ q & p ]

module _ {Î“ A B} where
    pÂ·F : Î“ [âŠ¢] B â†’ Î“ [âŠ¢] A â‡’ B
    pÂ·F ([ pÎ“ ]âŠ¢ ._) = [ pÎ“ ]âŠ¢ _ â‡’ _
    pÂ·F (._ âŠ¢[ pB ]) = _ âŠ¢[ _ â‡’[ pB ] ]

    pÂ·F2 : Î“ [âŠ¢]2 B â†’ Î“ [âŠ¢]2 A â‡’ B
    pÂ·F2 [ p ]     = [ pÂ·F p ]
    pÂ·F2 [ p & q ] = [ pÂ·F p & pÂ·F q ]

module _ {Î“ A} where
    swp2 : Î“ [âŠ¢]2 A â†’ Î“ [âŠ¢]2 A
    swp2 [ p ] = [ p ]
    swp2 [ p & q ] = [ q & p ]

pÆ›â†“ : âˆ€ {Î“ A B} â†’
        Î“ , A [âŠ¢] B â†’
        Î“ [âŠ¢] A â‡’ B
pÆ›â†“ ([ [ pÎ“ ], _ ]âŠ¢ _) = [ pÎ“ ]âŠ¢ _ â‡’ _
pÆ›â†“ ([ _ ,[ pA ] ]âŠ¢ _) = _ âŠ¢[ [ pA ]â‡’ _ ]
pÆ›â†“ (._ âŠ¢[ pB ])       = _ âŠ¢[ _ â‡’[ pB ] ]

Ok : âˆ€ {Î“ A B} â†’ Î“ [âŠ¢] A â‡’ B â†’ â˜…
Ok {Î“} {A} {B} ([ p ]âŠ¢ .(A â‡’ B)) = ğŸ™
Ok {Î“} (.Î“ âŠ¢[ âˆ™ ]) = ğŸ˜
Ok {Î“} {A} {B} (.Î“ âŠ¢[ [ pC ]â‡’ .B ]) = ğŸ™
Ok {Î“} {A} (.Î“ âŠ¢[ .A â‡’[ pC ] ]) = ğŸ™

module _ {Î“ A B} where
    Ok-pÆ›â†“ : (P : Î“ , A [âŠ¢] B) â†’ Ok (pÆ›â†“ P)
    Ok-pÆ›â†“ ([ [ _ ], ._ ]âŠ¢ ._)  = _
    Ok-pÆ›â†“ ([ ._ ,[ ._ ] ]âŠ¢ ._) = _
    Ok-pÆ›â†“ (._ âŠ¢[ _ ])          = _
    module Ok-pÆ›â†“ where
      Ok-pÆ›â†“' : âˆ€ {P} â†’ Ok (pÆ›â†“ P)
      Ok-pÆ›â†“' {P} = Ok-pÆ›â†“ P

pÆ›â†‘ : âˆ€ {Î“ A B} â†’
        (p : Î“ [âŠ¢] A â‡’ B) â†’
        (ok : Ok p) â†’
        Î“ , A [âŠ¢] B
pÆ›â†‘ ([ pÎ“ ]âŠ¢ ._) _ = [ [ pÎ“ ], _ ]âŠ¢ _
pÆ›â†‘ (_ âŠ¢[ [ pA ]â‡’ ._ ]) _ = [ _ ,[ pA ] ]âŠ¢ _
pÆ›â†‘ (_ âŠ¢[ ._ â‡’[ pB ] ]) _ = _ , _ âŠ¢[ pB ]
pÆ›â†‘ (_ âŠ¢[ âˆ™ ]) ()

pÆ›â†‘pÆ›â†“ : âˆ€ {Î“ A B} (p : Î“ , A [âŠ¢] B) â†’ pÆ›â†‘ (pÆ›â†“ p) (Ok-pÆ›â†“ p) â‰¡ p
pÆ›â†‘pÆ›â†“ {Î“} {A} {B} ([ [ p ], .A ]âŠ¢ .B) = â‰¡.refl
pÆ›â†‘pÆ›â†“ {Î“} {.A} {B} ([_]âŠ¢_ {.(Î“ , A)} {A} {.(top A)} {pá´¬} (.Î“ ,[ .pá´¬ ]) .B) = â‰¡.refl
pÆ›â†‘pÆ›â†“ {Î“} {A} (.(Î“ , A) âŠ¢[ pC ]) = â‰¡.refl

{-
pÆ›â†‘pÆ› : âˆ€ {Î“ A B} (p : Î“ [âŠ¢] A â‡’ B) â†’ pÆ›â†‘ (pÆ›â†“ p) â‰¡ p
pÆ›â†‘pÆ› p = ?
-}

Ok2 : âˆ€ {Î“ A B} â†’ Î“ [âŠ¢]2 A â‡’ B â†’ â˜…
Ok2 [ p ]     = Ok p
Ok2 [ p & q ] = Ok p Ã— Ok q

pÆ›2â†‘ : âˆ€ {Î“ A B} â†’
         (p : Î“ [âŠ¢]2 A â‡’ B) â†’
         (ok : Ok2 p) â†’
         Î“ , A [âŠ¢]2 B
pÆ›2â†‘ [ p ]     o          = [ pÆ›â†‘ p o ]
pÆ›2â†‘ [ p & q ] (op ,, oq) = [ pÆ›â†‘ p op & pÆ›â†‘ q oq ]

{-
data RÂ·F : âˆ€ {Î“ A B}
          (pÎ“ABâ‚€ : Î“ [âŠ¢] A â‡’ B) (pÎ“ABâ‚ : Î“ [âŠ¢] A â‡’ B)
          (pÎ“Bâ‚€ : Î“ [âŠ¢] B) (pÎ“Bâ‚ : Î“ [âŠ¢] B)
          â†’ â˜… where

  Â·[B&B] : âˆ€ {Î“ A B}
              {pá´®â†‘ : Ty[ B ]} {pá´®â†“ : Ty[ B ]}
            â†’ RÂ·F (Î“ âŠ¢[ A â‡’[ pá´®â†‘ ] ]) (_ âŠ¢[ _ â‡’[ pá´®â†“ ] ])
                  (_ âŠ¢[ pá´®â†‘ ])        (_ âŠ¢[ pá´®â†“ ])

  Â·[Î“&Î“] : âˆ€ {Î“ A B C D}
           {x : Î“ âˆ‹ C} {pCâ†‘ : Ty[ C ]} {pÎ“â†‘ : Ctx[ x Â· pCâ†‘ ]}
           {y : Î“ âˆ‹ D} {pDâ†“ : Ty[ D ]} {pÎ“â†“ : Ctx[ y Â· pDâ†“ ]}
         â†’ RÂ·F ([ pÎ“â†‘ ]âŠ¢ A â‡’ B) ([ pÎ“â†“ ]âŠ¢ A â‡’ B)
               ([ pÎ“â†‘ ]âŠ¢ B)     ([ pÎ“â†“ ]âŠ¢ B)

  Â·[Î“&B] : âˆ€ {Î“ A B C}
              {pá´®â†“ : Ty[ B ]}
              {x : Î“ âˆ‹ C} {pCâ†‘ : Ty[ C ]} {pÎ“â†‘ : Ctx[ x Â· pCâ†‘ ]}
            â†’ RÂ·F ([ pÎ“â†‘ ]âŠ¢ A â‡’ B) (Î“ âŠ¢[ A â‡’[ pá´®â†“ ] ])
                  ([ pÎ“â†‘ ]âŠ¢ B)     (Î“ âŠ¢[ pá´®â†“ ])

            {-
  -- swp _Â·[Î“&B]
  _Â·[Î“â…‹B] : âˆ€ {Î“ A B C} {M : Î“ âŠ¢ A â‡’ B} {N : Î“ âŠ¢ A}
              {pá´®â†“ : Ty[ B ]}
              {x : Î“ âˆ‹ C} {pCâ†‘ : Ty[ C ]} {pÎ“â†‘ : Ctx[ x Â· pCâ†‘ ]}
            â†’ Slice M       [ [ pÎ“â†‘ ]âŠ¢ A â‡’ B â…‹ Î“ âŠ¢[ A â‡’[ pá´®â†“ ] ] ]
            â†’ Slice (M Â· N) [ [ pÎ“â†‘ ]âŠ¢ B     â…‹ Î“ âŠ¢[ pá´®â†“ ]        ]
            -}

            {-
  _Â·[Bâ…‹B] : âˆ€ {Î“ A B} {M : Î“ âŠ¢ A â‡’ B} {N : Î“ âŠ¢ A}
              {pá´®â†‘ : Ty[ B ]} {pá´®â†“ : Ty[ B ]}
            â†’ Slice M       [ _ âŠ¢[ _ â‡’[ pá´®â†‘ ] ] â…‹ _ âŠ¢[ _ â‡’[ pá´®â†“ ] ] ]
            â†’ Slice (M Â· N) [ _ âŠ¢[ pá´®â†‘ ]        â…‹ _ âŠ¢[ pá´®â†“ ] ]
            -}
-}

data RÂ·AF : âˆ€ {Î“ A B}
              (pÎ“AB : Î“ [âŠ¢]2 A â‡’ B)
              (pÎ“A  : Î“ [âŠ¢]2 A)
              (pÎ“B  : Î“ [âŠ¢]2 B)
            â†’ â˜… where

  Â·A[Î“&âˆ™] : âˆ€ {Î“ A B C} {pá´¬ : Ty[ A ]}
              {x  : Î“ âˆ‹ C} {pC : Ty[ C ]} {pÎ“ : Ctx[ x Â· pC ]}
            â†’ RÂ·AF [ Î“ âŠ¢[ [ pá´¬ ]â‡’ B ] ]
                   [ [ pÎ“ ]âŠ¢ A & Î“ âŠ¢[ pá´¬ ] ]
                   [ [ pÎ“ ]âŠ¢ B ]

  Â·A[âˆ™&] : âˆ€ {Î“ A B} {pá´¬ : Ty[ A ]} {pÎ“B : Î“ [âŠ¢] B}
           â†’ RÂ·AF [ Î“ âŠ¢[ [ pá´¬ ]â‡’ B ] & pÂ·F pÎ“B ]
                  [ Î“ âŠ¢[ pá´¬ ] ]
                  [ pÎ“B ]

  Â·A[Î“&] : âˆ€ {Î“ A B C} {pá´¬ : Ty[ A ]}
             {x  : Î“ âˆ‹ C} {pC : Ty[ C ]} {pÎ“ : Ctx[ x Â· pC ]}
             {pÎ“B : Î“ [âŠ¢] B}
           â†’ RÂ·AF [ Î“ âŠ¢[ [ pá´¬ ]â‡’ B ] & pÂ·F pÎ“B ]
                  [ [ pÎ“ ]âŠ¢ A        & Î“ âŠ¢[ pá´¬ ] ]
                  [ [ pÎ“ ]âŠ¢ B        & pÎ“B ]

  Â·A[Î“â…‹] : âˆ€ {Î“ A B C} {pá´¬ : Ty[ A ]}
             {x  : Î“ âˆ‹ C} {pC : Ty[ C ]} {pÎ“ : Ctx[ x Â· pC ]}
             {pÎ“B : Î“ [âŠ¢] B}
           â†’ RÂ·AF [ Î“ âŠ¢[ [ pá´¬ ]â‡’ B ] & pÂ·F pÎ“B ]
                  [ [ pÎ“ ]âŠ¢ A        & Î“ âŠ¢[ pá´¬ ] ]
                  [ [ pÎ“ ]âŠ¢ B        â…‹ pÎ“B ]

{-
  Â·A[Î“&Î“] : âˆ€ {Î“ A B C D}
             {pá´¬  : Ty[ A ]}
             {x : Î“ âˆ‹ C} {pCâ†‘ : Ty[ C ]} {pÎ“â†‘ : Ctx[ x Â· pCâ†‘ ]}
             {y : Î“ âˆ‹ D} {pDâ†“ : Ty[ D ]} {pÎ“â†“ : Ctx[ y Â· pDâ†“ ]}
           â†’ RÂ·AF [ Î“ âŠ¢[ [ pá´¬ ]â‡’ B ] & [ pÎ“â†“ ]âŠ¢ A â‡’ B ]
                  [ [ pÎ“â†‘ ]âŠ¢ A       & Î“ âŠ¢[ pá´¬ ] ]
                  [ [ pÎ“â†‘ ]âŠ¢ B       & [ pÎ“â†“ ]âŠ¢ B ]
-}

                  {- subsumed by Â·A[âˆ™&]
  Â·A[âˆ™&B] : âˆ€ {Î“ A B C}
             {pá´¬ : Ty[ A ]}
             {pá´® : Ty[ B ]}
             {x  : Î“ âˆ‹ C} {pC : Ty[ C ]} {pÎ“ : Ctx[ x Â· pC ]}
           â†’ RÂ·AF [ Î“ âŠ¢[ [ pá´¬ ]â‡’ B ] & Î“ âŠ¢[ A â‡’[ pá´® ] ] ]
                  [ Î“ âŠ¢[ pá´¬ ] ]
                  [ Î“ âŠ¢[ pá´® ] ]

                   subsumed by Â·A[âˆ™&]
  Â·A[âˆ™&Î“] : âˆ€ {Î“ A B C D}
             {pá´¬  : Ty[ A ]}
             {x : Î“ âˆ‹ C} {pCâ†‘ : Ty[ C ]} {pÎ“â†‘ : Ctx[ x Â· pCâ†‘ ]}
             {y : Î“ âˆ‹ D} {pDâ†“ : Ty[ D ]} {pÎ“â†“ : Ctx[ y Â· pDâ†“ ]}
           â†’ RÂ·AF [ Î“ âŠ¢[ [ pá´¬ ]â‡’ B ] & [ pÎ“â†“ ]âŠ¢ A â‡’ B ]
                  [ Î“ âŠ¢[ pá´¬ ] ]
                  [ [ pÎ“â†“ ]âŠ¢ B ]
                  -}

           {-
  -- swp _Â·A[Î“&Î“]_
  _Â·A[Î“â…‹Î“]_ : âˆ€ {Î“ A B C D} {M : Î“ âŠ¢ A â‡’ B} {N : Î“ âŠ¢ A}
             {pá´¬  : Ty[ A ]}
             {x : Î“ âˆ‹ C} {pCâ†‘ : Ty[ C ]} {pÎ“â†‘ : Ctx[ x Â· pCâ†‘ ]}
             {y : Î“ âˆ‹ D} {pDâ†“ : Ty[ D ]} {pÎ“â†“ : Ctx[ y Â· pDâ†“ ]}
           â†’ Slice M       [ Î“ âŠ¢[ [ pá´¬ ]â‡’ B ] â…‹ [ pÎ“â†“ ]âŠ¢ A â‡’ B ]
           â†’ Slice N       [ [ pÎ“â†‘ ]âŠ¢ A       â…‹ Î“ âŠ¢[ pá´¬ ]  ]
           â†’ Slice (M Â· N) [ [ pÎ“â†‘ ]âŠ¢ B       â…‹ [ pÎ“â†“ ]âŠ¢ B ]
           -}

data _â‰ˆ_ {Î“ A} : (p2 q2 : Î“ [âŠ¢]2 A) â†’ â˜… where
  refl : âˆ€ {p2 : Î“ [âŠ¢]2 A} â†’ p2 â‰ˆ p2
  sym  : âˆ€ {p q : Î“ [âŠ¢] A} â†’ [ p & q ] â‰ˆ [ q & p ]

data Slice : âˆ€ {Î“ : Ctx} {A : Ty} (M : Î“ âŠ¢ A) â†’ Î“ [âŠ¢]2 A â†’ â˜… where
  -- V[Î“] : âˆ€ {Î“ A B} {x : Î“ âˆ‹ A} {y : Î“ âˆ‹ B} {pá´®â†‘ : Ty[ B â»]} (xâ‰ y : x â‰  y) â†’ (pÎ“â†‘ : Ctx[ y Â· pá´®â†‘ ]) â†’ Slice (V x) [ [ pÎ“â†‘ ]âŠ¢ âº]

 -- V {-[Î“&A]-} : âˆ€ {Î“ A} {x : Î“ âˆ‹ A} {pá´¬ : Ty[ A ]} (pÎ“ : Ctx[ x Â· pá´¬ ]) â†’ Slice (V x) [ [ pÎ“ ]âŠ¢ A & _ âŠ¢[ pá´¬ ] ]
 -- Vswp        : âˆ€ {Î“ A} {x : Î“ âˆ‹ A} {pá´¬ : Ty[ A ]} (pÎ“ : Ctx[ x Â· pá´¬ ]) {p q}  â†’ Slice (V x) [ _ âŠ¢[ pá´¬ ] & [ pÎ“ ]âŠ¢ _ ]
  V : âˆ€ {Î“ A} {x : Î“ âˆ‹ A} {pá´¬ : Ty[ A ]} (pÎ“ : Ctx[ x Â· pá´¬ ]) {p2} â†’ p2 â‰ˆ [ _ âŠ¢[ pá´¬ ] & [ pÎ“ ]âŠ¢ _ ] â†’ Slice (V x) p2

  -- swp V[Î“&A]
  {-
  V[Î“â…‹A] : âˆ€ {Î“ A} {x : Î“ âˆ‹ A} {pá´¬ : Ty[ A â»]} (pÎ“ : Ctx[ x Â· pá´¬ ]) â†’ Slice (V x) [ [ pÎ“ ]âŠ¢ _ â…‹ _ âŠ¢[ pá´¬ ]  ]
  -}

  {-
  Æ›[A] : âˆ€ {Î“ A B} {M : Î“ , A âŠ¢ B} {pá´¬â†‘ : Ty[ A ]}
         â†’ Slice M     [ [ Î“ ,[ pá´¬â†‘ ] ]âŠ¢ B ]
         â†’ Slice (Æ› M) [ Î“ âŠ¢[ [ pá´¬â†‘ ]â‡’ B ] ]
         
  Æ›[B] : âˆ€ {Î“ A B} {M : Î“ , A âŠ¢ B}
           {pá´®â†‘ : Ty[ B ]}
         â†’ Slice M     [ Î“ , A âŠ¢[ pá´®â†‘ ]    ]
         â†’ Slice (Æ› M) [ Î“ âŠ¢[ A â‡’[ pá´®â†‘ ] ] ]

  Æ›[Î“] : âˆ€ {Î“ A B C} {M : Î“ , A âŠ¢ B}
           {x : Î“ âˆ‹ C} {pCâ†‘ : Ty[ C ]} {pÎ“â†‘ : Ctx[ x Â· pCâ†‘ ]}
         â†’ Slice M     [ [ [ pÎ“â†‘ ], A ]âŠ¢ B ]
         â†’ Slice (Æ› M) [ [ pÎ“â†‘ ]âŠ¢ A â‡’ B    ]
  -}

  Æ› : âˆ€ {Î“ A B} {M : Î“ , A âŠ¢ B} p2 {{p2ok : Ok2 p2}}
      â†’ Slice M     (pÆ›2â†‘ p2 p2ok)
      â†’ Slice (Æ› M) p2

  {-
  Æ› : âˆ€ {Î“ A B} {M : Î“ , A âŠ¢ B} {pâ‚€ pâ‚} {{pâ‚€ok : Ok pâ‚€}} {{pâ‚ok : Ok pâ‚}}
      â†’ Slice M     [ pÆ›â†‘ pâ‚€ & pÆ›â†‘ pâ‚ ]
      â†’ Slice (Æ› M) [ pâ‚€     & pâ‚     ]
  -}

      {-
  Æ› : âˆ€ {Î“ A B} {M : Î“ , A âŠ¢ B} {s pâ‚€ pâ‚ pâ‚€' pâ‚'}
      â†’ RÆ› pâ‚€ pâ‚€'
      â†’ RÆ› pâ‚ pâ‚'
      â†’ Slice M     ^ _ [ pâ‚€  & pâ‚  ]
      â†’ Slice (Æ› M) ^ s [ pâ‚€' & pâ‚' ]
      -}

      {-
  Æ›[A&A] : âˆ€ {Î“ A B} {M : Î“ , A âŠ¢ B} {s}
             {pá´¬â†‘ : Ty[ A ]} {pá´¬â†“ : Ty[ A ]}
           â†’ Slice M     ^ _ [ [ Î“ ,[ pá´¬â†‘ ] ]âŠ¢ B & [ Î“ ,[ pá´¬â†“ ] ]âŠ¢ B ]
           â†’ Slice (Æ› M) ^ s [ Î“ âŠ¢[ [ pá´¬â†‘ ]â‡’ B ] & Î“ âŠ¢[ [ pá´¬â†“ ]â‡’ B ] ]

           {-
  -- swp Æ›[A&A]
  Æ›[Aâ…‹A] : âˆ€ {Î“ A B} {M : Î“ , A âŠ¢ B}
             {pá´¬â†‘ : Ty[ A â»]} {pá´¬â†“ : Ty[ A âº]}
           â†’ Slice M     [ [ Î“ ,[ pá´¬â†‘ ] ]âŠ¢ B â…‹ [ Î“ ,[ pá´¬â†“ ] ]âŠ¢ B ]
           â†’ Slice (Æ› M) [ Î“ âŠ¢[ [ pá´¬â†‘ ]â‡’ B ] â…‹ Î“ âŠ¢[ [ pá´¬â†“ ]â‡’ B ] ]
           -}

  Æ›[A&B] : âˆ€ {Î“ A B} {M : Î“ , A âŠ¢ B} {s}
             {pá´¬ : Ty[ A ]} {pá´® : Ty[ B ]}
           â†’ Slice M     ^ _ [ [ Î“ ,[ pá´¬ ] ]âŠ¢ B & Î“ , A âŠ¢[ pá´® ]    ]
           â†’ Slice (Æ› M) ^ s [ Î“ âŠ¢[ [ pá´¬ ]â‡’ B ] & Î“ âŠ¢[ A â‡’[ pá´® ] ] ]

           {-
  -- swp Æ›[A&B]
  Æ›[Aâ…‹B] : âˆ€ {Î“ A B} {M : Î“ , A âŠ¢ B}
             {pá´® : Ty[ B â»]} {pá´¬ : Ty[ A â»]}
           â†’ Slice M     [ [ Î“ ,[ pá´¬ ] ]âŠ¢ B â…‹ Î“ , A âŠ¢[ pá´® ]    ]
           â†’ Slice (Æ› M) [ Î“ âŠ¢[ [ pá´¬ ]â‡’ B ] â…‹ Î“ âŠ¢[ A â‡’[ pá´® ] ] ]
           -}

           {-
           â†’ Slice M     [ Î“ , A âŠ¢[ pá´® ]    & [ Î“ ,[ pá´¬ ] ]âŠ¢ B   ]
           â†’ Slice (Æ› M) [ Î“ âŠ¢[ A â‡’[ pá´® ] ] & Î“ âŠ¢[ [ pá´¬ ]â‡’ B ] ]
           -}
 
  Æ›[B&B] : âˆ€ {Î“ A B} {M : Î“ , A âŠ¢ B} {s}
             {pá´®â†‘ : Ty[ B ]} {pá´®â†“ : Ty[ B ]}
           â†’ Slice M     ^ _ [ Î“ , A âŠ¢[ pá´®â†‘ ]    & Î“ , A âŠ¢[ pá´®â†“ ]    ]
           â†’ Slice (Æ› M) ^ s [ Î“ âŠ¢[ A â‡’[ pá´®â†‘ ] ] & Î“ âŠ¢[ A â‡’[ pá´®â†“ ] ] ]

           {-
  Æ›[Bâ…‹B] : âˆ€ {Î“ A B} {M : Î“ , A âŠ¢ B}
             {pá´®â†‘ : Ty[ B ^ _ ]} {pá´®â†“ : Ty[ B ^ _ ]}
           â†’ Slice M     [ Î“ , A âŠ¢[ pá´®â†‘ ]    â…‹ Î“ , A âŠ¢[ pá´®â†“ ]    ]
           â†’ Slice (Æ› M) [ Î“ âŠ¢[ A â‡’[ pá´®â†‘ ] ] â…‹ Î“ âŠ¢[ A â‡’[ pá´®â†“ ] ] ]
           -}

  Æ›[Î“&A] : âˆ€ {Î“ A B C} {M : Î“ , A âŠ¢ B} {s}
             {x : Î“ âˆ‹ C} {pCâ†‘ : Ty[ C ^ _ ]} {pÎ“â†‘ : Ctx[ x Â· pCâ†‘ ]}
             {pá´¬â†“ : Ty[ A ^ _ ]}
           â†’ Slice M     ^ _ [ [ [ pÎ“â†‘ ], A ]âŠ¢ B & [ Î“ ,[ pá´¬â†“ ] ]âŠ¢ B ]
           â†’ Slice (Æ› M) ^ s [ [ pÎ“â†‘ ]âŠ¢ A â‡’ B    & Î“ âŠ¢[ [ pá´¬â†“ ]â‡’ B ] ]

           {-
  -- swp Æ›[Î“&A]
  Æ›[Î“â…‹A] : âˆ€ {Î“ A B C} {M : Î“ , A âŠ¢ B}
             {x : Î“ âˆ‹ C} {pCâ†‘ : Ty[ C ^ _ ]} {pÎ“â†‘ : Ctx[ x Â· pCâ†‘ ]}
             {pá´¬â†“ : Ty[ A ^ _ ]}
           â†’ Slice M     [ [ [ pÎ“â†‘ ], A ]âŠ¢ B â…‹ [ Î“ ,[ pá´¬â†“ ] ]âŠ¢ B ]
           â†’ Slice (Æ› M) [ [ pÎ“â†‘ ]âŠ¢ A â‡’ B    â…‹ Î“ âŠ¢[ [ pá´¬â†“ ]â‡’ B ] ]
           -}

  Æ›[Î“&B] : âˆ€ {Î“ A B C} {M : Î“ , A âŠ¢ B} {s}
             {x : Î“ âˆ‹ C} {pCâ†‘ : Ty[ C ^ _ ]} {pÎ“â†‘ : Ctx[ x Â· pCâ†‘ ]}
             {pá´®â†“ : Ty[ B ^ _ ]}
           â†’ Slice M     ^ _ [ [ [ pÎ“â†‘ ], A ]âŠ¢ B & Î“ , A âŠ¢[ pá´®â†“ ]    ]
           â†’ Slice (Æ› M) ^ s [ [ pÎ“â†‘ ]âŠ¢ A â‡’ B    & Î“ âŠ¢[ A â‡’[ pá´®â†“ ] ] ]

           {-
  -- swp Æ›[Î“&B]
  Æ›[Î“â…‹B] : âˆ€ {Î“ A B C} {M : Î“ , A âŠ¢ B}
             {x : Î“ âˆ‹ C} {pCâ†‘ : Ty[ C ^ _ ]} {pÎ“â†‘ : Ctx[ x Â· pCâ†‘ ]}
             {pá´®â†“ : Ty[ B ]}
           â†’ Slice M     [ [ [ pÎ“â†‘ ], A ]âŠ¢ B â…‹ Î“ , A âŠ¢[ pá´®â†“ ]    ]
           â†’ Slice (Æ› M) [ [ pÎ“â†‘ ]âŠ¢ A â‡’ B    â…‹ Î“ âŠ¢[ A â‡’[ pá´®â†“ ] ] ]
           -}

  Æ›[Î“&Î“] : âˆ€ {Î“ A B C D} {M : Î“ , A âŠ¢ B} {s}
             {x : Î“ âˆ‹ C} {pCâ†‘ : Ty[ C ]} {pÎ“â†‘ : Ctx[ x Â· pCâ†‘ ]}
             {y : Î“ âˆ‹ D} {pDâ†“ : Ty[ D ]} {pÎ“â†“ : Ctx[ y Â· pDâ†“ ]}
           â†’ Slice M     ^ _ [ [ [ pÎ“â†‘ ], A ]âŠ¢ B & [ [ pÎ“â†“ ], A ]âŠ¢ B ]
           â†’ Slice (Æ› M) ^ s [ [ pÎ“â†‘ ]âŠ¢ A â‡’ B    & [ pÎ“â†“ ]âŠ¢ A â‡’ B    ]

           {-
  Æ›[Î“â…‹Î“] : âˆ€ {Î“ A B C D} {M : Î“ , A âŠ¢ B}
             {x : Î“ âˆ‹ C} {pCâ†‘ : Ty[ C ]} {pÎ“â†‘ : Ctx[ x Â· pCâ†‘ ]}
             {y : Î“ âˆ‹ D} {pDâ†“ : Ty[ D ]} {pÎ“â†“ : Ctx[ y Â· pDâ†“ ]}
           â†’ Slice M     [ [ [ pÎ“â†‘ ], A ]âŠ¢ B â…‹ [ [ pÎ“â†“ ], A ]âŠ¢ B ]
           â†’ Slice (Æ› M) [ [ pÎ“â†‘ ]âŠ¢ A â‡’ B    â…‹ [ pÎ“â†“ ]âŠ¢ A â‡’ B    ]
           -}
  -}

  Â·FA : âˆ€ {Î“ A B} {M : Î“ âŠ¢ A â‡’ B} {N : Î“ âŠ¢ A}
          {pÎ“AB : Î“ [âŠ¢]2 A â‡’ B}
          {pÎ“A  : Î“ [âŠ¢]2 A}
          {pÎ“B  : Î“ [âŠ¢]2 B}
          (rÂ·AF : RÂ·AF pÎ“AB pÎ“A pÎ“B)
          (PM   : Slice M pÎ“AB)
          (PN   : Slice N pÎ“A)
        â†’ Slice (M Â· N) pÎ“B

  Â·F : âˆ€ {Î“ A B} {M : Î“ âŠ¢ A â‡’ B} {N : Î“ âŠ¢ A}
         {pÎ“B : Î“ [âŠ¢]2 B}
       â†’ Slice M       (pÂ·F2 pÎ“B)
       â†’ Slice (M Â· N) pÎ“B

        {-
  Â·F : âˆ€ {Î“ A B} {M : Î“ âŠ¢ A â‡’ B} {N : Î“ âŠ¢ A}
          {pÎ“ABâ‚€ : Î“ [âŠ¢] A â‡’ B} {pÎ“ABâ‚ : Î“ [âŠ¢] A â‡’ B}
          {pÎ“Bâ‚€ : Î“ [âŠ¢] B} {pÎ“Bâ‚ : Î“ [âŠ¢] B}
        â†’ RÂ·F pÎ“ABâ‚€ pÎ“ABâ‚ pÎ“Bâ‚€ pÎ“Bâ‚
          âŠ
          RÂ·F pÎ“ABâ‚€ pÎ“ABâ‚ pÎ“Bâ‚ pÎ“Bâ‚€
        â†’ Slice M       [ pÎ“ABâ‚€ & pÎ“ABâ‚ ]
        â†’ Slice (M Â· N) [ pÎ“Bâ‚€  & pÎ“Bâ‚ ]
-}
          {-
  Â·A : âˆ€ {Î“ A B} {M : Î“ âŠ¢ A â‡’ B} {N : Î“ âŠ¢ A}
          {pÎ“Aâ‚€ : Î“ [âŠ¢] A} {pÎ“Aâ‚ : Î“ [âŠ¢] A}
          {pÎ“Bâ‚€ : Î“ [âŠ¢] B} {pÎ“Bâ‚ : Î“ [âŠ¢] B}
        â†’ RÂ·A pÎ“Aâ‚€ pÎ“Aâ‚ pÎ“Bâ‚€ pÎ“Bâ‚
          âŠ
          RÂ·A pÎ“Aâ‚€ pÎ“Aâ‚ pÎ“Bâ‚ pÎ“Bâ‚€
        â†’ Slice N       [ pÎ“Aâ‚€  & pÎ“Aâ‚ ]
        â†’ Slice (M Â· N) [ pÎ“Bâ‚€  & pÎ“Bâ‚ ]
        -}

  Â·A : âˆ€ {Î“ A B C D} {M : Î“ âŠ¢ A â‡’ B} {N : Î“ âŠ¢ A}
         {x : Î“ âˆ‹ C} {pCâ†‘ : Ty[ C ]} {pÎ“â†‘ : Ctx[ x Â· pCâ†‘ ]}
         {y : Î“ âˆ‹ D} {pDâ†“ : Ty[ D ]} {pÎ“â†“ : Ctx[ y Â· pDâ†“ ]}
        â†’ Slice N       [ [ pÎ“â†‘ ]âŠ¢ A & [ pÎ“â†“ ]âŠ¢ A ]
        â†’ Slice (M Â· N) [ [ pÎ“â†‘ ]âŠ¢ B & [ pÎ“â†“ ]âŠ¢ B ]

Path : âˆ€ {Î“ : Ctx} {A : Ty} (M : Î“ âŠ¢ A) â†’ Î“ [âŠ¢] A â†’ â˜…
Path {Î“} {A} M p = Î£ (Î“ [âŠ¢] A) (Î» q â†’ Slice M [ p & q ])
                 âŠ Slice M [ p ]

 -- swp  : âˆ€ {Î“ : Ctx} {A : Ty} {M : Î“ âŠ¢ A} {s} {p : Î“ [âŠ¢ _ ] A} {q : Î“ [âŠ¢ _ ] A} â†’ Slice M ^ (op s) [ q & p ] â†’ Slice M ^ s [ p & opopâŠ¢ q ]
--  swp' : {Î“ : Ctx} {A : Ty} {M : Î“ âŠ¢ A} {p : Î“ [âŠ¢ âº ] A} {q : Î“ [âŠ¢ â» ] A} â†’ Slice M [ p â…‹ q ] â†’ Slice M [ q & p ]
-- agsy: swp x = {!-c!}

module _ {Î“ A} where
    â‰ˆ-sym : {p2 q2 : Î“ [âŠ¢]2 A} â†’ p2 â‰ˆ q2 â†’ q2 â‰ˆ p2
    â‰ˆ-sym refl = refl
    â‰ˆ-sym sym  = sym

    â‰ˆ-trans : {p2 q2 r2 : Î“ [âŠ¢]2 A} â†’ p2 â‰ˆ q2 â†’ q2 â‰ˆ r2 â†’ p2 â‰ˆ r2
    â‰ˆ-trans refl qr   = qr
    â‰ˆ-trans pr   refl = pr
    â‰ˆ-trans sym sym   = refl

    â‰ˆ-swp : (p2 : Î“ [âŠ¢]2 A) â†’ p2 â‰ˆ swp2 p2
    â‰ˆ-swp [ p ]     = refl
    â‰ˆ-swp [ p & q ] = sym

swp  : âˆ€ {Î“ : Ctx} {A : Ty} {M : Î“ âŠ¢ A} (p2 : Î“ [âŠ¢]2 A) â†’ Slice M p2 â†’ Slice M (swp2 p2)
swp [ p ] (V pÎ“ xâ‚) = V pÎ“ xâ‚
swp [ p ] (Â·FA rÂ·AF P Pâ‚) = Â·FA rÂ·AF P Pâ‚
swp [ p ] (Â·F P) = Â·F P
swp [ p ] (Æ› ._ P) = Æ› _ (swp _ P)
swp [ p & q ] (V pÎ“ xâ‚) = V pÎ“ (â‰ˆ-trans (â‰ˆ-swp _) xâ‚)
swp [ p & q ] (Æ› ._ {{_ ,, _}} P) = Æ› [ q & p ] {{â€¦ ,, â€¦}} (swp [ pÆ›â†‘ p â€¦ & pÆ›â†‘ q â€¦ ] P)
swp [ ._ & q ] (Â·FA (Â·A[Î“&]) P Pâ‚) = Â·FA Â·A[Î“â…‹] P Pâ‚
swp [ p & ._ ] (Â·FA (Â·A[Î“â…‹]) P Pâ‚) = Â·FA Â·A[Î“&] P Pâ‚
swp [ p & q ] (Â·F P) = Â·F (swp _ P)
swp [ ._ & ._ ] (Â·A P) = Â·A (swp _ P)

{-
Æ›â†“ : âˆ€ {Î“ A B} {M : Î“ , A âŠ¢ B} {pâ‚€ pâ‚}
     â†’ Slice M     [ pâ‚€     & pâ‚     ]
     â†’ Slice (Æ› M) [ pÆ›â†“ pâ‚€ & pÆ›â†“ pâ‚ ]
Æ›â†“ {Î“} {A} {B} {M} {pâ‚€} {pâ‚} P = {!Æ› [ pâ‚€ & pâ‚ ] {{Ok-pÆ›â†“ pâ‚€ ,, Ok-pÆ›â†“ pâ‚}}
                                   ({!â‰¡.subst (Î» p â†’ Slice M [ p & _ ]) (â‰¡.sym (pÆ›â†‘pÆ›â†“ pâ‚€))
                                     (â‰¡.subst (Î» p â†’ Slice M [ _ & p ]) (â‰¡.sym (pÆ›â†‘pÆ›â†“ pâ‚)) P!})!}
                                     -}

_$â„¢_ : âˆ€ {Î“ Î” A} â†’ Î“ â‡‰ Î” â†’ Î“ âŠ¢ A â†’ Î” âŠ¢ A
f $â„¢ (V x)   = V (f x)
f $â„¢ (M Â· N) = f $â„¢ M Â· f $â„¢ N
f $â„¢ (Æ› M)   = Æ› (extâ‡‰ f $â„¢ M)

infix 0 _â‡¶_
_â‡¶_ : (Î“ Î” : Ctx) â†’ â˜…
Î“ â‡¶ Î” = âˆ€ {B} â†’ Î“ âˆ‹ B â†’ Î” âŠ¢ B

extâ‡¶ : âˆ€ {Î“ Î” A} â†’ Î“ â‡¶ Î” â†’ Î“ , A â‡¶ Î” , A
extâ‡¶ f (top A)   = V (top A)
extâ‡¶ f (pop B x) = (Î» Î“ â†’ pop B Î“) $â„¢ f x

infix 8 _=<<â„¢_
_=<<â„¢_ : âˆ€ {Î“ Î” A} â†’ Î“ â‡¶ Î” â†’ Î“ âŠ¢ A â†’ Î” âŠ¢ A
f =<<â„¢ V x     = f x
f =<<â„¢ (M Â· N) = f =<<â„¢ M Â· f =<<â„¢ N
f =<<â„¢ Æ› M     = Æ› (extâ‡¶ f =<<â„¢ M)

subst0 : âˆ€ {Î“ A} â†’ Î“ âŠ¢ A â†’ Î“ , A â‡¶ Î“
subst0 M (top A)   = M
subst0 M (pop B x) = V x

cut : âˆ€ {Î“ A B} â†’ Î“ , A âŠ¢ B â†’ Î“ âŠ¢ A â†’ Î“ âŠ¢ B
cut M N = subst0 N =<<â„¢ M

infix 0 _â†_
data _â†_ : âˆ€ {Î“ A} (M N : Î“ âŠ¢ A) â†’ â˜… where
  Î² : âˆ€ {Î“ A B} {M : Î“ , A âŠ¢ B} {N : Î“ âŠ¢ A} â†’ Æ› M Â· N â† cut M N
  [_]Â·_ : âˆ€ {Î“ A B} {M Mâ€² : Î“ âŠ¢ A â‡’ B} {N : Î“ âŠ¢ A} â†’ M â† Mâ€² â†’ M Â· N â† Mâ€² Â· N
  _Â·[_] : âˆ€ {Î“ A B} {M : Î“ âŠ¢ A â‡’ B} {N Nâ€² : Î“ âŠ¢ A} â†’ N â† Nâ€² â†’ M Â· N â† M Â· Nâ€²
  Æ› : âˆ€ {Î“ A B} {M Mâ€² : Î“ , A âŠ¢ B} â†’ M â† Mâ€² â†’ Æ› M â† Æ› Mâ€²

idâ„¢ : âˆ€ {Î“} â†’ Î“ âŠ¢ a â‡’ a
idâ„¢ = Æ› (V (top a))

pid : Slice idâ„¢ [ Îµ âŠ¢[ [ âˆ™ ]â‡’ a ] & Îµ âŠ¢[ _ â‡’[ âˆ™ ] ] ]
pid = Æ› _ (V (Îµ ,[ âˆ™ ]) sym) -- by refines and agsy

idâ„¢â€² : Îµ âŠ¢ a â‡’ a
idâ„¢â€² = Æ› (idâ„¢ Â· V (top a))

idâ€²â†id : idâ„¢â€² â† idâ„¢
idâ€²â†id = Æ› Î²

V0 : âˆ€ {Î“ A} â†’ Î“ , A âŠ¢ A
V0 = V (top _)

V1 : âˆ€ {Î“ A B} â†’ Î“ , A , B âŠ¢ A
V1 = V (pop _ (top _))

pV0 : âˆ€ {Î“ A p} â†’ Slice (V0 {Î“} {A}) [ [ Î“ ,[ p ] ]âŠ¢ A & Î“ , A âŠ¢[ p ] ] 
pV0 = V (_ ,[ _ ]) sym

pV1 : âˆ€ {Î“ A B p} â†’ Slice (V1 {Î“} {A} {B}) [ [ [ Î“ ,[ p ] ], B ]âŠ¢ A & _ âŠ¢[ p ] ]
pV1 = V ([ _ ,[ _ ] ], _) sym

-- Î» f. Î» x. f x x
exâ‚€ : Îµ âŠ¢ (a â‡’ a â‡’ b) â‡’ a â‡’ b
exâ‚€ = Æ› (Æ› (V (pop _ (top (a â‡’ a â‡’ b))) Â· V (top a) Â· V (top a)))

pâ‚€exâ‚€ : Slice exâ‚€ [ Îµ âŠ¢[ (a â‡’ a â‡’ b) â‡’[ [ âˆ™ ]â‡’ b ] ]
                 & Îµ âŠ¢[ [ [ âˆ™ ]â‡’ a â‡’ b ]â‡’ a â‡’ b ] ]
pâ‚€exâ‚€ = Æ› _ (Æ› _ (Â·F (Â·FA Â·A[Î“&] (V _ refl) (V _ sym))))

pâ‚exâ‚€ : Slice exâ‚€ [ _ âŠ¢[ _ â‡’[ [ âˆ™ ]â‡’ _ ] ] & _ âŠ¢[ [ _ â‡’[ [ âˆ™ ]â‡’ _ ] ]â‡’ _ ] ]
pâ‚exâ‚€ = Æ› _ (Æ› _ (Â·FA Â·A[Î“&] (Â·F (V _ refl)) (V _ sym)))

{-
data Unie {Î“ A} : (pâ‚€ pâ‚ qâ‚€ qâ‚ : Î“ [âŠ¢] A) â†’ â˜… where
  id : âˆ€ {p q} â†’ Unie p q p q
  sw : âˆ€ {p q} â†’ Unie p q q p

Unie : âˆ€ {Î“ A} (pâ‚€ pâ‚ qâ‚€ qâ‚ : Î“ [âŠ¢] A) â†’ â˜…
Unie pâ‚€ pâ‚ qâ‚€ qâ‚ = (pâ‚€ â‰¡ qâ‚€ â†’ pâ‚ â‰¡ qâ‚) âŠ (pâ‚€ â‰¡ qâ‚ â†’ pâ‚ â‰¡ qâ‚€)
  
Unie' : âˆ€ {Î“ A} (pâ‚€ pâ‚ qâ‚€ qâ‚ : Î“ [âŠ¢] A) (pf : pâ‚€ â‰¡ qâ‚€ âŠ pâ‚€ â‰¡ qâ‚) â†’ â˜…
Unie' pâ‚€ pâ‚ qâ‚€ qâ‚ (injâ‚ x) = pâ‚ â‰¡ qâ‚
Unie' pâ‚€ pâ‚ qâ‚€ qâ‚ (injâ‚‚ y) = pâ‚ â‰¡ qâ‚€

Unie : âˆ€ {Î“ A} (pâ‚€ pâ‚ qâ‚€ qâ‚ : Î“ [âŠ¢] A) â†’ â˜…
Unie pâ‚€ pâ‚ qâ‚€ qâ‚ = (pf : pâ‚€ â‰¡ qâ‚€ âŠ pâ‚€ â‰¡ qâ‚) â†’ Unie' pâ‚€ pâ‚ qâ‚€ qâ‚ pf
-}

module _ {Î“ A B} where
    pÂ·F-inj : âˆ€ {p q : Î“ [âŠ¢] B} â†’ pÂ·F {Î“} {A} p â‰¡ pÂ·F {Î“} {A} q â†’ p â‰¡ q
    pÂ·F-inj {[ .p ]âŠ¢ .B} {[ p ]âŠ¢ .B} â‰¡.refl = â‰¡.refl
    pÂ·F-inj {[ p ]âŠ¢ .B} {.Î“ âŠ¢[ pC ]} ()
    pÂ·F-inj {.Î“ âŠ¢[ pC ]} {[ p ]âŠ¢ .B} ()
    pÂ·F-inj {.Î“ âŠ¢[ .pC ]} {.Î“ âŠ¢[ pC ]} â‰¡.refl = â‰¡.refl

    pÆ›â†‘-inj : âˆ€ {p q : Î“ [âŠ¢] A â‡’ B} (p-ok : Ok p) (q-ok : Ok q) â†’ pÆ›â†‘ p p-ok â‰¡ pÆ›â†‘ q q-ok â†’ p â‰¡ q
    pÆ›â†‘-inj {[ .pâ‚ ]âŠ¢ .(A â‡’ B)} {[ pâ‚ ]âŠ¢ .(A â‡’ B)} p-ok q-ok â‰¡.refl = â‰¡.refl
    pÆ›â†‘-inj {[ p ]âŠ¢ .(A â‡’ B)} {.Î“ âŠ¢[ âˆ™ ]} p-ok () pf
    pÆ›â†‘-inj {[ p ]âŠ¢ .(A â‡’ B)} {.Î“ âŠ¢[ [ pC ]â‡’ .B ]} p-ok q-ok ()
    pÆ›â†‘-inj {[ p ]âŠ¢ .(A â‡’ B)} {.Î“ âŠ¢[ .A â‡’[ pC ] ]} p-ok q-ok ()
    pÆ›â†‘-inj {.Î“ âŠ¢[ âˆ™ ]} {[ p ]âŠ¢ .(A â‡’ B)} () q-ok pf
    pÆ›â†‘-inj {.Î“ âŠ¢[ [ pC ]â‡’ .B ]} {[ p ]âŠ¢ .(A â‡’ B)} p-ok _ ()
    pÆ›â†‘-inj {.Î“ âŠ¢[ .A â‡’[ pC ] ]} {[ p ]âŠ¢ .(A â‡’ B)} p-ok q-ok ()
    pÆ›â†‘-inj {.Î“ âŠ¢[ âˆ™ ]} {.Î“ âŠ¢[ âˆ™ ]} p-ok q-ok pf = {!!}
    pÆ›â†‘-inj {.Î“ âŠ¢[ âˆ™ ]} {.Î“ âŠ¢[ [ pCâ‚ ]â‡’ .B ]} p-ok q-ok pf = {!!}
    pÆ›â†‘-inj {.Î“ âŠ¢[ âˆ™ ]} {.Î“ âŠ¢[ .A â‡’[ pCâ‚ ] ]} p-ok q-ok pf = {!!}
    pÆ›â†‘-inj {.Î“ âŠ¢[ [ pC ]â‡’ .B ]} {.Î“ âŠ¢[ âˆ™ ]} p-ok q-ok pf = {!!}
    pÆ›â†‘-inj {.Î“ âŠ¢[ [ pC ]â‡’ .B ]} {.Î“ âŠ¢[ [ pCâ‚ ]â‡’ .B ]} p-ok q-ok pf = {!!}
    pÆ›â†‘-inj {.Î“ âŠ¢[ [ pC ]â‡’ .B ]} {.Î“ âŠ¢[ .A â‡’[ pCâ‚ ] ]} p-ok q-ok pf = {!!}
    pÆ›â†‘-inj {.Î“ âŠ¢[ .A â‡’[ pC ] ]} {.Î“ âŠ¢[ âˆ™ ]} p-ok q-ok pf = {!!}
    pÆ›â†‘-inj {.Î“ âŠ¢[ .A â‡’[ pC ] ]} {.Î“ âŠ¢[ [ pCâ‚ ]â‡’ .B ]} p-ok q-ok pf = {!!}
    pÆ›â†‘-inj {.Î“ âŠ¢[ .A â‡’[ pC ] ]} {.Î“ âŠ¢[ .A â‡’[ pCâ‚ ] ]} p-ok q-ok pf = {!!}

uniCtx : âˆ€ {Î“ A} (x : Î“ âˆ‹ A) {pá´¬ : Ty[ A ]} â†’ (pÎ“ pÎ“' : Ctx[ x Â· pá´¬ ]) â†’ pÎ“ â‰¡ pÎ“'
uniCtx {.(Î“ , A)} {A} (top {Î“} .A) {pá´¬} (.Î“ ,[ .pá´¬ ]) (.Î“ ,[ .pá´¬ ]) = â‰¡.refl
uniCtx (pop B x) ([ pÎ“ ], .B) ([ pÎ“' ], .B) rewrite uniCtx x pÎ“ pÎ“' = â‰¡.refl

--[]âŠ¢-inj : 

unie : âˆ€ {Î“} {A : Ty} {M : Î“ âŠ¢ A} {b p q : Î“ [âŠ¢] A} (P : Slice M [ b & p ]) (Q : Slice M [ b & q ]) â†’ p â‰¡ q
unie (V pÎ“ refl) (V pÎ“â‚ refl) rewrite uniCtx _ pÎ“ pÎ“â‚ = â‰¡.refl
unie (V .pÎ“â‚ sym) (V pÎ“â‚ sym) = â‰¡.refl
unie {b = b'} {p} {q} (Æ› ._ {{_ ,, _}} P) (Æ› ._ {{_ ,, _}} Q) = pÆ›â†‘-inj â€¦ â€¦ (unie P Q)
unie (Â·FA rÂ·AF P Pâ‚) (Â·FA rÂ·AFâ‚ Q Qâ‚) = {!!}
unie (Â·FA rÂ·AF P Pâ‚) (Â·F Q) = {!!}
unie (Â·FA rÂ·AF P Pâ‚) (Â·A Q) = {!!}
unie (Â·F P) (Â·FA rÂ·AF Q Qâ‚) = {!!}
unie (Â·F P) (Â·F Q) = pÂ·F-inj (unie P Q)
unie (Â·F P) (Â·A Q) = {!!}
unie (Â·A P) (Â·FA rÂ·AF Q Qâ‚) = {!!}
unie (Â·A P) (Â·F Q) = {!!}
unie (Â·A P) (Â·A Q) = {![]âŠ¢-inj (unie P Q)!}

{-
unie : âˆ€ {Î“ A} {M : Î“ âŠ¢ A} {pâ‚€ pâ‚ qâ‚€ qâ‚ : Î“ [âŠ¢] A} (P : Slice M [ pâ‚€ & pâ‚ ]) (Q : Slice M [ qâ‚€ & qâ‚ ]) â†’ Unie pâ‚€ pâ‚ qâ‚€ qâ‚
-}

--P same-path Q = âˆƒ (Ï€ : Iso (Î“ [âŠ¢] A)). Slice M [ b & p ] âˆˆ P â†’ Slice M [ b & Ï€ p ] âˆˆ Q

uni : âˆ€ {Î“ A} {M : Î“ âŠ¢ A} {b eâ‚€ eâ‚ : Î“ [âŠ¢] A} (P : Slice M [ b & eâ‚€ ]) (Q : Slice M [ b & eâ‚ ]) â†’ {!P !} -- Î£ (eâ‚€ â‰¡ eâ‚) (Î» Ï€ â†’ subst (Î» e â†’ Slice M [ b & e ]) Ï€ P â‰¡ Q)
uni P Q = {!-c cong!}
{-
uni P Q = {!-c cong!}
{-
uni (V[Î“&A] pÎ“â†‘) (V[Î“&A] .pÎ“â†‘) = refl
uni (V[Î“â…‹A] pÎ“â†“) (V[Î“â…‹A] .pÎ“â†“) = refl
uni (Æ›[A&A] P) (Æ›[A&A] Q) = cong Æ›[A&A] (uni P Q)
uni (Æ›[A&B] P) (Æ›[A&B] Q) = cong Æ›[A&B] (uni P Q)
uni (Æ›[Aâ…‹B] P) (Æ›[Aâ…‹B] Q) = cong Æ›[Aâ…‹B] (uni P Q)
uni (Æ›[B&B] P) (Æ›[B&B] Q) = cong Æ›[B&B] (uni P Q)
uni (Æ›[Î“&A] P) (Æ›[Î“&A] Q) = cong Æ›[Î“&A] (uni P Q)
uni (Æ›[Î“â…‹A] P) (Æ›[Î“â…‹A] Q) = cong Æ›[Î“â…‹A] (uni P Q)
uni (Æ›[Î“&B] P) (Æ›[Î“&B] Q) = cong Æ›[Î“&B] (uni P Q)
uni (Æ›[Î“â…‹B] P) (Æ›[Î“â…‹B] Q) = cong Æ›[Î“â…‹B] (uni P Q)
uni (Æ›[Î“&Î“] P) (Æ›[Î“&Î“] Q) = cong Æ›[Î“&Î“] (uni P Q)
uni (P Â·[B&B]) (Q Â·[B&B]) = cong _Â·[B&B] (uni P Q)
uni ([Î“&Î“]Â· P) ([Î“&Î“]Â· Q) = cong [Î“&Î“]Â·_ (uni P Q)
uni ([Î“&Î“]Â· P) (Q Â·[Î“&Î“]) = {!uni P Q!}
uni ([Î“&Î“]Â· P) (Q Â·A[Î“&Î“] Qâ‚) = {!cong!}
uni ([Î“&Î“]Â· P) (Q Â·A[Î“â…‹Î“] Qâ‚) = {!cong!}
uni (P Â·[Î“&Î“]) ([Î“&Î“]Â· Q) = {!cong!}
uni (P Â·[Î“&Î“]) (Q Â·[Î“&Î“]) = cong _Â·[Î“&Î“] (uni P Q)
uni (P Â·[Î“&Î“]) (Q Â·A[Î“&Î“] Qâ‚) = {!cong!}
uni (P Â·[Î“&Î“]) (Q Â·A[Î“â…‹Î“] Qâ‚) = {!cong!}
uni (P Â·[Î“&B]) (Q Â·[Î“&B]) = cong _Â·[Î“&B] (uni P Q)
uni (P Â·[Î“&B]) (Q Â·A[Î“&B] Qâ‚) = {!cong!}
uni (P Â·[Î“â…‹B]) (Q Â·[Î“â…‹B]) = cong _Â·[Î“â…‹B] (uni P Q)
uni (P Â·[Î“â…‹B]) (Q Â·A[Î“â…‹B] Qâ‚) = {!!}
uni (P Â·A[Î“&B] Pâ‚) (Q Â·[Î“&B]) = {!!}
uni (P Â·A[Î“&B] Pâ‚) (Q Â·A[Î“&B] Qâ‚) = {!uni P Q!} -- {!congâ‚‚ _Â·A[Î“&B]_ (uni P Q) (uni Pâ‚ Qâ‚)!}
uni (P Â·A[Î“â…‹B] Pâ‚) (Q Â·[Î“â…‹B]) = {!!}
uni (P Â·A[Î“â…‹B] Pâ‚) (Q Â·A[Î“â…‹B] Qâ‚) = {!!}
uni (P Â·A[Î“&Î“] Pâ‚) ([Î“&Î“]Â· Q) = {!!}
uni (P Â·A[Î“&Î“] Pâ‚) (Q Â·[Î“&Î“]) = {!!}
uni (P Â·A[Î“&Î“] Pâ‚) (Q Â·A[Î“&Î“] Qâ‚) = {!!}
uni (P Â·A[Î“&Î“] Pâ‚) (Q Â·A[Î“â…‹Î“] Qâ‚) = {!!}
uni (P Â·A[Î“â…‹Î“] Pâ‚) ([Î“&Î“]Â· Q) = {!!}
uni (P Â·A[Î“â…‹Î“] Pâ‚) (Q Â·[Î“&Î“]) = {!!}
uni (P Â·A[Î“â…‹Î“] Pâ‚) (Q Â·A[Î“&Î“] Qâ‚) = {!!}
uni (P Â·A[Î“â…‹Î“] Pâ‚) (Q Â·A[Î“â…‹Î“] Qâ‚) = {!!}
{-
{-
record CE : â˜… where
  field
    Î“     : Ctx
    A     : Ty
    M     : Î“ âŠ¢ A
    p0 p1 : Î“ [âŠ¢] A
    P0 P1 : Slice M [ p0 & p1 ]
    P0â‰¢P1 : P0 â‰¢ P1

ce : CE
ce = ?
-}

module MCE where
    Î“ : Ctx
    Î“ = Îµ , a

    A : Ty
    A = a

    M : Î“ âŠ¢ A
    M = (Æ› (Æ› (V (pop a (pop (a â‡’ a) (top a)))))) Â· Æ› (V (top a)) Â· V (top a)

    p0 : Î“ [âŠ¢] A
    p0 = [ Îµ ,[ âˆ™ ] ]âŠ¢ _

    p1 : Î“ [âŠ¢] A
    p1 = _ âŠ¢[ âˆ™ ]

    P0 : Slice M [ p0 & p1 ]
    P0 = {!!} Â·A[Î“&B] V[Î“&A] (Îµ ,[ âˆ™ ])

    {-
    P1-0 : Slice (V (pop a (pop (a â‡’ a) (top {Îµ} a)))) [ [ [ [ _ ,[ âˆ™ ] ], _ ], _ ]âŠ¢ a & _ âŠ¢[ âˆ™ ] ]
    P1-0 = V[Î“&A] ([ [ Îµ ,[ âˆ™ ] ], a â‡’ a ], a)

    P1-1 : Slice (Æ› (V (pop a (pop (a â‡’ a) (top {Îµ} a))))) [ [ [ _ ,[ âˆ™ ] ], _ ]âŠ¢ _ & _ âŠ¢[ _ â‡’[ âˆ™ ] ] ]
    P1-1 = Æ›[Î“&B] P1-0

    P1-2 : Slice (Æ› (Æ› (V (pop a (pop (a â‡’ a) (top {Îµ} a)))))) [ [ _ ,[ âˆ™ ] ]âŠ¢ _ & _ âŠ¢[ _ â‡’[ _ â‡’[ âˆ™ ] ] ] ]
    P1-2 = Æ›[Î“&B] P1-1

    P1-3 : Slice (Æ› (Æ› (V (pop a (pop (a â‡’ a) (top {Îµ} a))))) Â· Æ› (V (top a))) [ [ _ ,[ âˆ™ ] ]âŠ¢ _ & _ âŠ¢[ _ â‡’[ âˆ™ ] ] ]
    P1-3 = P1-2 Â·[Î“&B]
    -}

    P1 : Slice M [ p0 & p1 ]
    P1 = (Æ›[B&B] (Æ›[A&B] {!!}) Â·[B&B]) Â·A[Î“&B] V[Î“&A] {!!}

    P0â‰¢P1 : P0 â‰¢ P1
    P0â‰¢P1 p = {!!}
-- -}
-- -}
-- -}
-- -}
-- -}
-- -}
-- -}
-- -}
-- -}
-- -}
-- -}
-- -}
